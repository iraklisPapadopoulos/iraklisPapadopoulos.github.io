---
layout: post
title:  Kaplan-Meier survival estimate
date: 2023-12-07 21:01:00
description: Principal theory and R code for KM survival estimate and comparissons between survival curves
tags: survival
categories: visualization
thumbnail: assets/img/posts/survival/vaxPrimo.jpg
bibliography: survival.bib
toc:
  sidebar: left
  
---


## Introduction
This post presents the basic theory on Survival Analysis and provide R code to produce Kaplan-Meier plots.


### The basics


The Kaplan-Meier estimator is used to estimate the survival function from censored data. The survival function \hat{S}(t) represents the probability that a subject survives beyond time 
\t. The Kaplan-Meier estimator is defined as follows:

<p>Identify all unique event times (times at which events occur) and censoring times. Denote them as \(t_1, t_2, \ldots, t_k\).</p>


<p>The survival probability at the first event time (\(t_1\)) is calculated as:</p>
<p>\[ \hat{S}(t_1) = 1 \]</p>
<p>Since there are no events before \(t_1\), the probability of surviving beyond \(t_1\) is 1.</p>

<p>For each subsequent event time \(t_i\), where \(i > 1\), the survival probability is calculated using the formula:</p>
<p>\[ \hat{S}(t_i) = \hat{S}(t_{i-1}) \times \left(1 - \frac{d_i}{n_i}\right) \]</p>
<p>where:</p>
<ul>
  <li>\(d_i\) is the number of events at time \(t_i\).</li>
  <li>\(n_i\) is the number of subjects at risk just before time \(t_i\).</li>
</ul>

<p>If there are censored observations at any time point \(t_i\), adjust the probability as follows:</p>
<p>\[ \hat{S}(t_i) = \hat{S}(t_{i-1}) \times \left(1 - \frac{d_i}{n_i}\right)^{1 - c_i} \]</p>
<p>where \(c_i\) is the number of censored observations at time \(t_i\).</p>

<p>The final survival probability at the last event time (\(t_k\)) is the product of all the individual survival probabilities:</p>
<p>\[ \hat{S}(t_k) = \hat{S}(t_{k-1}) \times \left(1 - \frac{d_k}{n_k}\right)^{1 - c_k} \]</p>

### Packages

<div class="row mt-4">
    <div class="col-6 col-sm-3 mt-4 mt-md-0">
        {% include figure.html path="assets/img/posts/survival/ggplot2.jpg" class="img-fluid rounded z-depth-1" style="max-width: 100px; max-height: 100px;"  %}
    </div>
    <div class="col-6 col-sm-3 mt-4 mt-md-0">
        {% include figure.html path="assets/img/posts/survival/tibble.jpeg" class="img-fluid rounded z-depth-1" style="max-width: 100px; max-height: 100px;"  %}
    </div>
    
</div>
<div class="caption">
    Libraries for this post.
</div>

```R
# Load required libraries
library(survival)
library(tibble)
library(ggplot2)
library(survminer)
```

### The dataset

For this post, we'll generate a dataset with five variables: patient ID, time to event (survival time), event indicator (whether the event occurred or not), and a binary treatment variable (0 or 1) to represent whether each patient received a particular treatment.

```R
# Set a seed for reproducibility
set.seed(123)

# Number of observations
n <- 100

# Generate an imaginary ID
id <- 1:n

# Generate a covariate (continuous)
covariate <- rnorm(n)

# Generate a binary treatment variable (0 or 1)
treatment <- rbinom(n, size = 1, prob = 0.5)

# Generate survival time (time to event)
time <- rexp(n, rate = ifelse(treatment == 1, 0.08, 0.1))  # Higher rate for Treatment A

# Create event indicator (1=event occurred, 0=censored)
event <- rbinom(n, size = 1, prob = pexp(time, rate = 0.1))

# Map treatment categories to "Treatment A" and "Placebo"
treatment_category <- factor(ifelse(treatment == 1, "Treatment A", "Placebo"), levels = c("Placebo", "Treatment A"))

# Create a data frame
data <- tibble(
  ID = id,
  Time = pmin(time, 10),  # Truncate survival time at 10 units for illustration
  Event = event,
  Covariate = covariate,
  Treatment = treatment_category
)

# Display the first few rows of the dataset
head(data)

```

## Kaplan-Meier Plots

```R

# Fit Kaplan-Meier survival curve
fit_km <- survfit(Surv(Time, Event) ~ Treatment, data = data)

# Plot Kaplan-Meier curves
g <- ggsurvplot(
  fit_km,
  data = data,
  risk.table = TRUE,
  pval = TRUE,
  conf.int = TRUE,
  ggtheme = theme_minimal(),
  palette = c("#0073C2FF", "#EFC000FF"),  # Blue for Treatment A, Yellow for Placebo
  legend.title = "Treatment",
  legend.labs = c("Treatment A", "Placebo"),
  xlab = "Time",
  ylab = "Survival Probability",
  main = "Kaplan-Meier Survival Curves by Treatment"
)

print(g)

```
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/img/posts/survival/km.jpeg" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
  <div class="caption">
    Kaplan-Meier curves for the treatment goup.
</div>

## Comparing Survival Curves between Groups

```R
# Perform log-rank test
logrank_test <- survdiff(Surv(Time, Event) ~ Treatment, data = data)

# Display the log-rank test results
print(logrank_test)
```

